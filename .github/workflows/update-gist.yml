name: Mirror sample-code to Gist

on:
  push:
    paths:
      - 'sample-code/**'
    branches:
      - main
  delete:
    paths:
      - 'sample-code/**'

jobs:
  sync-to-gist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Mirror sample-code to Gist
        env:
          GIST_ID: ff4744ea8665a67d797e36f85e5de726
          GITHUB_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          python3 <<'PYCODE'
          import os, requests, json

          gist_id = os.environ["GIST_ID"]
          token = os.environ["GITHUB_TOKEN"]
          headers = {
              "Authorization": f"token {token}",
              "Accept": "application/vnd.github.v3+json"
          }

          # --- 1. Fetch current Gist state ---
          gist_url = f"https://api.github.com/gists/{gist_id}"
          resp = requests.get(gist_url, headers=headers)
          if resp.status_code != 200:
              print("❌ Failed to fetch Gist:", resp.status_code, resp.text)
              exit(1)
          gist_data = resp.json()
          existing_files = set(gist_data["files"].keys())

          # --- 2. Collect local files under sample-code (exclude .DS_Store) ---
          local_files = {}
          for root, _, filenames in os.walk("sample-code"):
              for f in filenames:
                  if f == ".DS_Store":
                      continue
                  path = os.path.join(root, f)
                  rel = os.path.relpath(path, "sample-code")
                  with open(path, "r", encoding="utf-8") as fh:
                      local_files[rel] = {"content": fh.read()}

          # --- 3. Determine files to delete from Gist ---
          files_to_delete = existing_files - set(local_files.keys())

          # --- 4. Prepare payload ---
          payload_files = local_files.copy()
          for f in files_to_delete:
              payload_files[f] = None  # Mark for deletion

          # --- 5. Send PATCH request to update Gist ---
          data = {"files": payload_files}
          patch_resp = requests.patch(gist_url, headers=headers, data=json.dumps(data))
          if patch_resp.status_code >= 300:
              print("❌ Failed to update Gist:", patch_resp.status_code, patch_resp.text)
              exit(1)

          print(f"✅ Gist {gist_id} successfully synced.")
          print(f"  → {len(local_files)} files updated/added")
          print(f"  → {len(files_to_delete)} files deleted")
          PYCODE
