name: Mirror sample-code to Gist

on:
  push:
    branches:
      - main                   # Or adjust your default branch name
  delete:
    paths:
      - 'sample-code/**'

jobs:
  sync-to-gist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python (optional, just for convenience)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install gist CLI
        run: |
          sudo npm install -g gist-cli

      - name: Mirror files to Gist
        env:
          GIST_ID: ff4744ea8665a67d797e36f85e5de726
          GITHUB_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          # Create a temp directory for Gist content
          mkdir gist_sync
          cd sample-code

          # Find all files except .DS_Store
          find . -type f ! -name '.DS_Store' > ../gist_sync/filelist.txt
          cd ../gist_sync

          # Download current Gist content
          gist download $GIST_ID --token $GITHUB_TOKEN

          # Remove all files in Gist folder to ensure sync
          find . -type f ! -name 'filelist.txt' -delete

          # Copy updated files preserving relative paths
          cd ..
          while IFS= read -r file; do
            mkdir -p "gist_sync/$(dirname "$file")"
            cp "sample-code/$file" "gist_sync/$file"
          done < gist_sync/filelist.txt

          cd gist_sync

          # Re-upload the entire folder to the Gist
          gist edit $GIST_ID $(find . -type f ! -name 'filelist.txt') --token $GITHUB_TOKEN
